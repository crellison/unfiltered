#!/usr/bin/env node
const mongoose = require('mongoose');
const request  = require('request');
const cheerio  = require('cheerio');

const Tweets   = require('../models');

// ------------------------------------
// CONNECT TO DATABASE
// ------------------------------------

var connect = process.env.MONGODB_URI;
mongoose.connect(connect);

var db = mongoose.connection;
db.once('open', () => console.log("DB Connected!"));

Tweets.latestID((err,tweet) => {
  // tweet[0].twitterID
  db.close();
  request('http://twitter.com/realDonaldTrump', (err, resp, body) => {
    var tweets = cheerio(body).find('.tweet');
    this.completed = false;
    for (var i = 0; i < tweets.length; i++) {
      if (tweets[i].attribs['data-permalink-path'] !== tweet[0].twitterLink) {
        request.post({
          url: 'http://unfiltered.herokuapp.com/new-tweet', 
          form: {tweetURI: `http://twitter.com/${tweets[i].attribs['data-permalink-path']}`},
          function(err, resp, body) {
            console.log(resp.statusCode === 200 ? `added tweet ${tweets[i].attribs['data-tweet-id']}` : `error adding tweet ${current.attribs['data-tweet-id']}`);
          }
        })
      } else {
        if (this.completed === false) {
          console.log('all new tweets accounted for');
          this.completed = true;
        }
      }
    }
  })
})